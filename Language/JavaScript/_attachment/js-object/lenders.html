<!DOCTYPE html>
<html>
<head>
	<title>JavaScript Loan Calculator</title>
	<style type="text/css">/*这是一个CSS样式表*/
	.output{font-weight: bold;}
	#payment{text-decoration: underline;}
	#graph{border: solid black 1px;}
	th,td{vertical-align: top;}
	</style>


</head>

<body>
	<!---
	这是一个HTML表格
	-->

	<table>
		<tr>
			<th>Enter Loan Data:</th>
			<td></td>
			<th>Loan Balance, Cumulative Equity, and Interest Payments</th>
		</tr>
		<tr>
			<td>Amount of the loan($):</td>
			<td><input id="amount" onchange="calculate();"></td>
			<td rowspan=8>
				<canvas id="graph" width="400" height="250"></canvas>
			</td>
		</tr>
		<tr><td>Annual interest(%):</td>
			<td><input id="apr" onchange="calculate();"></td>
		</tr>

		<tr><td>Repayment period(years):</td>
			<td><input id="apr" onchange="calculate();"></td>
		</tr>

		<tr>
			<td>Zipcode(to find leaders):</td>
			<td><input id="zipcode" onchange="calculate();"></td>
		</tr>

		<tr>
			<th>Approximate Payments:</th>
			<td><button onclick="calculate();">Calculate</button></td>
		</tr>

		<tr><td>Monthly payment:</td><td>$<span class="output" id="payment"></span></td></tr>

		<tr>
			<td>Total payment:</td>
			<td>$<span class="output" id="payment"></span></td>
		</tr>		

		<tr>
			<td>Total interest:</td>
			<td>$<span class="output" id="totalinterest"></span></td>
		</tr>

		<tr>
			<th>Sponsors:</th><td colspan=2>Apply for your loan with one of these fine lenders:<div id="lenders"></div></td>
		</tr>

	</table>

	<script type="text/javascript">
		"use strict"://如果浏览器支持，开启ECMAScript严格模式
		//定义calculate()函数，从<input>元素中读取数据，计算贷款赔付信息，并将结果显示在<span>元素中
		//此外还保存了用户数据，展示了放贷人链接并绘制出了图表
		function calculate(){
			//假设所有输入合法
			var amount = document.getElementById("amount");
			var apr = document.getElementById("apr");
			var years = document.getElementById("years");
			var zipcode = document.getElementById("zipcode");
			var payment = document.getElementById("payment");
			var total = document.getElementById("total");
			var totalinterest = document.getElementById("totalinterest");
			
			//将年利率转为月利率，百分比转为小数，年度赔付转换为月度赔付
			var principal = parseFloat(amount.value);
			var interest = parseFloat(apr.value)/100/12;
			var payments = parseFloat(years.value)*12;//计算月度赔付的数据
			var x = Math.pow(1+interest,payments);
			var monthly = (principal*x*interest)/(x-1);//若结果在取值范围内,且用户输入正确
			if(isFinite(monthly)){
				payment.innerHTML=monthly.toFixed(2);
				total.innerHTML=(monthly*payments).toFixed(2);
				totalinterest.innerHTML=((monthly*payments)-principal).toFixed(2);
				save(amount.value,apr.value,years.value,zipcode.value);//
				//找到并展示本地放贷人，但忽略网络错误
				try{
					getLenders(amount.value,apr.value,years.value,zipcode.value);
				}

				catch(e){
					chart(principal,interest,monthly,payments);
				}
				else{
					//清空之前输入的数据
					payment.innerHTML="";
					total.innerHTML="";
					totalinterest.innerHTML="";
					chart();//不传参即为清除图表
				}

				//将用户的输入保存至localStorage对象的属性中
				//若在浏览器中按照file://URL的方式直接打开本地文件，则无法在某些浏览器中使用存储功能（如Firefox），而通过http是可行的
				function save(amount,apr,years,zipcode){
					if(window.localStorage){//浏览器支持本地存储
						localStorage.loan_amount=amount;
						localStorage.loan_apr=apr;
						localStorage.loan_years=years;
						localStorage.loan_zipcode=zipcode;
					}
				}
				//在文档首次加载时，将会尝试还原输入字段
				window.onload=function(){
					//若浏览器支持本地存储且上次保存的值是存在的
					if(window.localStorage&&localStorage.loan_amount){
						document.getElementById("amount").value=localStorage.loan_amount;
						document.getElementById("apr").value=localStorage.loan_apr;
						document.getElementById("years").value=localStorage.loan_years;
						document.getElementById("zipcode").value=localStorage.loan_zipcode;
					}
				};

				//将用户的输入发送至服务器端脚本将返回一个本地放贷人的链接列表，本例中并未实现这种查找放贷人的服务
				function getLenders(amount,apr,years,zipcode){
					//若浏览器不支持XMLHttpRequest对象则退出
					if(!window.XMLHttpRequest)return;
					var ad=document.getElementById("lenders");
					if(!ad)return;//返回为空则退出

					//将用户的输入进行URL编码，并作为查询参数加入URL
					var url="getLenders.php"
							+"?amt="
							+encodeURLComponent(amount)
							+"?apr"
							+encodeURLComponent(apr)
							+"?yrs"
							+encodeURLComponent(years)
							+"?zip"
							+encodeURLComponent(zipcode);
					var req=new XMLHttpRequest();//发起一个新的请求
					req.open("GET",url);
					req.send(null);
					//返回数据之前，注册一个事件处理函数，该函数将在服务器的响应返回至客户端时调用
					req.onreadystatechange=function(){
						if(req.readState==4&&req.status==200)//说明得到一个合法完整的http响应
							var response=req.responseText;//http响应以字符串形式
							var lenders=JSON.parse(response);//解析成json数组
							//将数组中的放贷人对象转换为html字符串形式
					}
				}
			}
		}
	</script>